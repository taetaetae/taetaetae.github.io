<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>스프링을 활용한 대용량 파일 업로드 구현 - 👨‍💻꿈꾸는 태태태의 공간</title><meta name=Description content><meta property="og:title" content="스프링을 활용한 대용량 파일 업로드 구현"><meta property="og:description" content="개발을 하다보면 실제로 직접 구현을 해본적은 없지만 여기저기서 들어본 지식과 그 동안의 짬밥(?)으로 추측해볼수 있는 부분들이 있다. 물론 모든일에 정답은 없겠지만 요즘 느끼는건 책에서 공부만 해본것과 다른 블로그들에서 눈으로만 보고 넘어가는것들 그리고 직접 손가락을 움직여가며 왜 여기서는 이 방법을 사용하지 고민하면서 구현을 해본다는건 정말 엄청나게 큰 차이가 있는것 같다. 웹 어플리케이션을 개발하다보면 한번 쯤 만나게 되는 파일 업로드 기능. 필자도 몇번 구현은 해봤지만 그냥 단순히 구현만 해본 상태였다가 최근에 그냥 파일 업로드가 아닌 대용량 파일 업로드에서의 문제가 발생하여 여기저기 삽질을 하게 되었고 정리도 해볼겸 스프링에서의 대용량 파일 업로드시 한번쯤 고려해봐야 할 부분에 대해 정리를 해보려고 한다.
 물론 구글에서 검색을 해보면 아마 필자가 쓴것 보다 더 자세하고 좋은 글들이 있겠지만 필자는 보다 대용량에 집중에서 작성해 보고자 한다. 명심하자. &ldquo;아무리 흐린 잉크라도 좋은 기억력보다 낫다&rdquo; 라는 말이 있듯이
 스프링을 활용한 파일 업로드 구현 우선 완전 초기상태에서 시작하기 위해 스프링 부트 프로젝트를 만들고 간단하게 파일 업로드를 할 수 있는 form 페이지와 업로드 버튼을 눌렀을때 작동하게 되는 컨트롤러를 만들어 보자.
import java.io.File; import java.io.IOException; import java.io.InputStream; import org.apache.commons.io.FileUtils; import org.springframework.stereotype.Controller; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RequestMethod; import org.springframework.web.bind.annotation.RequestParam; import org.springframework.web.multipart.MultipartFile; import lombok.extern.slf4j.Slf4j; @Slf4j @Controller public class FileUploadController { // 너무 간단 ... 	@RequestMapping(&#34;/form&#34;) public String form() { return &#34;form&#34;; } @RequestMapping(value = &#34;/upload&#34;, method = RequestMethod.POST) public String upload(@RequestParam(&#34;file&#34;) MultipartFile multipartFile) { log.info(&#34;### upload&#34;); File targetFile = new File(&#34;/home1/irteam/&#34; + multipartFile.getOriginalFilename()); try { InputStream fileStream = multipartFile.getInputStream(); FileUtils.copyInputStreamToFile(fileStream, targetFile); } catch (IOException e) { FileUtils.deleteQuietly(targetFile); e.printStackTrace(); } return &#34;redirect:/form&#34;; } } upload 요청이 들어오면 file이라는 이름의 파라미터로 MultipartFile을 받고 파일의 이름을 확인 후 스트림을 읽어 특정 경로에 파일로 저장하는 로직이다. 그다음 /form을 접속하게 되면 나오는 폼 화면을 만들자. 이것도 아주 심플하게!
<h1>파일 업로드</h1> <form action=&#34;/upload&#34; method=&#34;post&#34; enctype=&#34;multipart/form-data&#34;> <input type=&#34;file&#34; value=&#34;파일 선택&#34; name=&#34;file&#34;/> <input type=&#34;submit&#34; value=&#34;업로드&#34;/> </form> multipart/form-data 라는 Content-Type 을 명시해주고 파일을 선택하면 /upload로 POST요청을 하도록 설정한다. 이렇게 되면 너무 간단하게 + 이상없이 파일이 업로드가 잘 되니 이게 이야기 할 꺼리인가(?) 싶을정도로 심플하다.
그런데 파일 크기가 크다면? 설마 파일 업로드 하는 용량이 크겠어?&mldr; 왠지 파일의 용량이 크면 문제있을것 같은데&mldr; 출처 : https://m.blog.naver.com/naibbo0407/30170815180&#34; 설마 파일 업로드 하는 용량이 크겠어?&mldr; 왠지 파일의 용량이 크면 문제있을것 같은데&mldr; 출처 : https://m.blog.naver.com/naibbo0407/30170815180  개발을 하다보면 항상 생각해야 할 부분중에 하나가 바로 확장성인것 같다. 이 부분에서 역시 문제가 되었던 것. 평소보다 용량이 큰 파일이 업로드가 되면서 (평소 3~400MB 였다가 3~4GB정도의 파일이 업로드가 되는 매직) 업로드가 안되는 상황이 발생하였다. 당연히 문제가 발생하면 누군가 말했듯 로그부터 살펴보았는데 Apache - (AJP) - Tomcat 으로 구성된 환경에서 tomcat 로그에 ### upload라는 로그가 없고 아파치 로그엔 502 에러가 발생한 것이었다. 왜 톰켓 로그도 안남고 그전에 에러가 발생하였을까? 이때부터 (근거없는 추측을 하며&mldr;) 고난과 역경의 삽질을 하기 시작하게 된다. 톰켓 버전이 문제일까? 로그가 안찍혔다면 다른 필터나 인터셉터에서 무언가를 먹고(?)있는건 아닐까? 잠깐, 근데 원래 대용량 업로드가 되긴 해? 파일 업로드/다운로드 하는 사이트 보면 별도 프로그램으로 하던데&mldr; 꼬불꼬불 미로속을 헤메는것만 같았던 삽질의 문제는 결국 메모리에 있었다. 파일을 업로드 하게 되면 해당 내용을 우선 메모리에 담게 되고 다 담은 후 메모리에 있는 내용을 was에 전달한 뒤 HttpServletRequest 로 넘어오게 된다.(Apache > Tomcat) 그런데 파일을 업로드 하면서 메모리에 파일이 써지다가 메모리 부족으로 OOM이 발생하게 되버린 것이었다. 또한 스프링 파일 최대크기를 별도로 지정하지 않고 있었기 때문에 메모리가 충분했다 하더라도 에러가 발생했을 상황이었다."><meta property="og:type" content="article"><meta property="og:url" content="https://taetaetae.github.io/2019/07/21/spring-file-upload/"><meta property="og:image" content="https://taetaetae.github.io/images/spring-file-upload/upload.png"><meta property="article:published_time" content="2019-07-21T22:09:58+00:00"><meta property="article:modified_time" content="2019-07-21T22:09:58+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://taetaetae.github.io/images/spring-file-upload/upload.png"><meta name=twitter:title content="스프링을 활용한 대용량 파일 업로드 구현"><meta name=twitter:description content="개발을 하다보면 실제로 직접 구현을 해본적은 없지만 여기저기서 들어본 지식과 그 동안의 짬밥(?)으로 추측해볼수 있는 부분들이 있다. 물론 모든일에 정답은 없겠지만 요즘 느끼는건 책에서 공부만 해본것과 다른 블로그들에서 눈으로만 보고 넘어가는것들 그리고 직접 손가락을 움직여가며 왜 여기서는 이 방법을 사용하지 고민하면서 구현을 해본다는건 정말 엄청나게 큰 차이가 있는것 같다. 웹 어플리케이션을 개발하다보면 한번 쯤 만나게 되는 파일 업로드 기능. 필자도 몇번 구현은 해봤지만 그냥 단순히 구현만 해본 상태였다가 최근에 그냥 파일 업로드가 아닌 대용량 파일 업로드에서의 문제가 발생하여 여기저기 삽질을 하게 되었고 정리도 해볼겸 스프링에서의 대용량 파일 업로드시 한번쯤 고려해봐야 할 부분에 대해 정리를 해보려고 한다.
 물론 구글에서 검색을 해보면 아마 필자가 쓴것 보다 더 자세하고 좋은 글들이 있겠지만 필자는 보다 대용량에 집중에서 작성해 보고자 한다. 명심하자. &ldquo;아무리 흐린 잉크라도 좋은 기억력보다 낫다&rdquo; 라는 말이 있듯이
 스프링을 활용한 파일 업로드 구현 우선 완전 초기상태에서 시작하기 위해 스프링 부트 프로젝트를 만들고 간단하게 파일 업로드를 할 수 있는 form 페이지와 업로드 버튼을 눌렀을때 작동하게 되는 컨트롤러를 만들어 보자.
import java.io.File; import java.io.IOException; import java.io.InputStream; import org.apache.commons.io.FileUtils; import org.springframework.stereotype.Controller; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RequestMethod; import org.springframework.web.bind.annotation.RequestParam; import org.springframework.web.multipart.MultipartFile; import lombok.extern.slf4j.Slf4j; @Slf4j @Controller public class FileUploadController { // 너무 간단 ... 	@RequestMapping(&#34;/form&#34;) public String form() { return &#34;form&#34;; } @RequestMapping(value = &#34;/upload&#34;, method = RequestMethod.POST) public String upload(@RequestParam(&#34;file&#34;) MultipartFile multipartFile) { log.info(&#34;### upload&#34;); File targetFile = new File(&#34;/home1/irteam/&#34; + multipartFile.getOriginalFilename()); try { InputStream fileStream = multipartFile.getInputStream(); FileUtils.copyInputStreamToFile(fileStream, targetFile); } catch (IOException e) { FileUtils.deleteQuietly(targetFile); e.printStackTrace(); } return &#34;redirect:/form&#34;; } } upload 요청이 들어오면 file이라는 이름의 파라미터로 MultipartFile을 받고 파일의 이름을 확인 후 스트림을 읽어 특정 경로에 파일로 저장하는 로직이다. 그다음 /form을 접속하게 되면 나오는 폼 화면을 만들자. 이것도 아주 심플하게!
<h1>파일 업로드</h1> <form action=&#34;/upload&#34; method=&#34;post&#34; enctype=&#34;multipart/form-data&#34;> <input type=&#34;file&#34; value=&#34;파일 선택&#34; name=&#34;file&#34;/> <input type=&#34;submit&#34; value=&#34;업로드&#34;/> </form> multipart/form-data 라는 Content-Type 을 명시해주고 파일을 선택하면 /upload로 POST요청을 하도록 설정한다. 이렇게 되면 너무 간단하게 + 이상없이 파일이 업로드가 잘 되니 이게 이야기 할 꺼리인가(?) 싶을정도로 심플하다.
그런데 파일 크기가 크다면? 설마 파일 업로드 하는 용량이 크겠어?&mldr; 왠지 파일의 용량이 크면 문제있을것 같은데&mldr; 출처 : https://m.blog.naver.com/naibbo0407/30170815180&#34; 설마 파일 업로드 하는 용량이 크겠어?&mldr; 왠지 파일의 용량이 크면 문제있을것 같은데&mldr; 출처 : https://m.blog.naver.com/naibbo0407/30170815180  개발을 하다보면 항상 생각해야 할 부분중에 하나가 바로 확장성인것 같다. 이 부분에서 역시 문제가 되었던 것. 평소보다 용량이 큰 파일이 업로드가 되면서 (평소 3~400MB 였다가 3~4GB정도의 파일이 업로드가 되는 매직) 업로드가 안되는 상황이 발생하였다. 당연히 문제가 발생하면 누군가 말했듯 로그부터 살펴보았는데 Apache - (AJP) - Tomcat 으로 구성된 환경에서 tomcat 로그에 ### upload라는 로그가 없고 아파치 로그엔 502 에러가 발생한 것이었다. 왜 톰켓 로그도 안남고 그전에 에러가 발생하였을까? 이때부터 (근거없는 추측을 하며&mldr;) 고난과 역경의 삽질을 하기 시작하게 된다. 톰켓 버전이 문제일까? 로그가 안찍혔다면 다른 필터나 인터셉터에서 무언가를 먹고(?)있는건 아닐까? 잠깐, 근데 원래 대용량 업로드가 되긴 해? 파일 업로드/다운로드 하는 사이트 보면 별도 프로그램으로 하던데&mldr; 꼬불꼬불 미로속을 헤메는것만 같았던 삽질의 문제는 결국 메모리에 있었다. 파일을 업로드 하게 되면 해당 내용을 우선 메모리에 담게 되고 다 담은 후 메모리에 있는 내용을 was에 전달한 뒤 HttpServletRequest 로 넘어오게 된다.(Apache > Tomcat) 그런데 파일을 업로드 하면서 메모리에 파일이 써지다가 메모리 부족으로 OOM이 발생하게 되버린 것이었다. 또한 스프링 파일 최대크기를 별도로 지정하지 않고 있었기 때문에 메모리가 충분했다 하더라도 에러가 발생했을 상황이었다."><meta name=application-name content="👨‍💻꿈꾸는 태태태의 공간"><meta name=apple-mobile-web-app-title content="👨‍💻꿈꾸는 태태태의 공간"><meta name=naver-site-verification content="2d1cdbb963ba178aa7cbf58500afc668cae1e645"><meta name=google-site-verification content="vvFCdv0-GuQhEWG8vtNJfA7YSY2HYQ1hpHh9P-a6Pv8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://taetaetae.github.io/2019/07/21/spring-file-upload/><link rel=prev href=https://taetaetae.github.io/2019/07/07/review-first-half-2019/><link rel=next href=https://taetaetae.github.io/2019/08/04/apache-load-balancing/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"스프링을 활용한 대용량 파일 업로드 구현","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/taetaetae.github.io\/2019\/07\/21\/spring-file-upload\/"},"genre":"posts","keywords":"fileupload, spring, archives-2019","wordcount":679,"url":"https:\/\/taetaetae.github.io\/2019\/07\/21\/spring-file-upload\/","datePublished":"2019-07-21T22:09:58+00:00","dateModified":"2019-07-21T22:09:58+00:00","publisher":{"@type":"Organization","name":"태태태"},"author":{"@type":"Person","name":"태태태"},"description":""}</script></head><body header-desktop=auto header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="👨‍💻꿈꾸는 태태태의 공간">👨‍💻꿈꾸는 태태태의 공간</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="👨‍💻꿈꾸는 태태태의 공간">👨‍💻꿈꾸는 태태태의 공간</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/>Posts</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/categories/>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div><script async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><ins class=adsbygoogle style=display:inline-block;width:260px;height:600px data-ad-client=ca-pub-5788330009690816 data-ad-slot=2248955907></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><article class="page single"><h1 class="single-title animated flipInX">스프링을 활용한 대용량 파일 업로드 구현</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://taetaetae.github.io/resume title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>태태태</a></span>&nbsp;<span class=post-category>included in <a href=/categories/tech/><i class="far fa-folder fa-fw"></i>Tech</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2019-07-21>2019-07-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;679 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/images/spring-file-upload/upload.png data-srcset="/images/spring-file-upload/upload.png, /images/spring-file-upload/upload.png 1.5x, /images/spring-file-upload/upload.png 2x" data-sizes=auto alt=/images/spring-file-upload/upload.png title=/images/spring-file-upload/upload.png></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#스프링을-활용한-파일-업로드-구현>스프링을 활용한 파일 업로드 구현</a></li><li><a href=#그런데-파일-크기가-크다면>그런데 파일 크기가 크다면?</a></li><li><a href=#삽질은-곧-경험이-되고-시야가-된다>삽질은 곧 경험이 되고 시야가 된다.</a></li></ul></nav></div></div><div class=content id=content><p>개발을 하다보면 실제로 직접 구현을 해본적은 없지만 여기저기서 들어본 지식과 그 동안의 짬밥(?)으로 추측해볼수 있는 부분들이 있다. 물론 모든일에 정답은 없겠지만 요즘 느끼는건 책에서 공부만 해본것과 다른 블로그들에서 눈으로만 보고 넘어가는것들 그리고 직접 손가락을 움직여가며 왜 여기서는 이 방법을 사용하지 고민하면서 구현을 해본다는건 정말 엄청나게 큰 차이가 있는것 같다.
웹 어플리케이션을 개발하다보면 한번 쯤 만나게 되는 <code>파일 업로드</code> 기능. 필자도 몇번 구현은 해봤지만 그냥 단순히 <code>구현</code>만 해본 상태였다가 최근에 그냥 파일 업로드가 아닌 <code>대용량</code> 파일 업로드에서의 문제가 발생하여 여기저기 삽질을 하게 되었고 정리도 해볼겸 스프링에서의 대용량 파일 업로드시 한번쯤 고려해봐야 할 부분에 대해 정리를 해보려고 한다.</p><blockquote><p>물론 구글에서 검색을 해보면 아마 필자가 쓴것 보다 더 자세하고 좋은 글들이 있겠지만 필자는 보다 <code>대용량</code>에 집중에서 작성해 보고자 한다. 명심하자. &ldquo;아무리 흐린 잉크라도 좋은 기억력보다 낫다&rdquo; 라는 말이 있듯이</p></blockquote><h2 id=스프링을-활용한-파일-업로드-구현>스프링을 활용한 파일 업로드 구현</h2><p>우선 완전 초기상태에서 시작하기 위해 스프링 부트 프로젝트를 만들고 간단하게 파일 업로드를 할 수 있는 form 페이지와 업로드 버튼을 눌렀을때 작동하게 되는 컨트롤러를 만들어 보자.</p><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=kn>import</span> <span class=nn>java.io.File</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.io.IOException</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.io.InputStream</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>org.apache.commons.io.FileUtils</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.stereotype.Controller</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.bind.annotation.RequestMapping</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.bind.annotation.RequestMethod</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.bind.annotation.RequestParam</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.multipart.MultipartFile</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>lombok.extern.slf4j.Slf4j</span><span class=o>;</span>

<span class=nd>@Slf4j</span>
<span class=nd>@Controller</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>FileUploadController</span> <span class=o>{</span>

	<span class=c1>// 너무 간단 ...
</span><span class=c1></span>	<span class=nd>@RequestMapping</span><span class=o>(</span><span class=s>&#34;/form&#34;</span><span class=o>)</span>
	<span class=kd>public</span> <span class=n>String</span> <span class=nf>form</span><span class=o>()</span> <span class=o>{</span>
		<span class=k>return</span> <span class=s>&#34;form&#34;</span><span class=o>;</span>
	<span class=o>}</span>

	<span class=nd>@RequestMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;/upload&#34;</span><span class=o>,</span> <span class=n>method</span> <span class=o>=</span> <span class=n>RequestMethod</span><span class=o>.</span><span class=na>POST</span><span class=o>)</span>
	<span class=kd>public</span> <span class=n>String</span> <span class=nf>upload</span><span class=o>(</span><span class=nd>@RequestParam</span><span class=o>(</span><span class=s>&#34;file&#34;</span><span class=o>)</span> <span class=n>MultipartFile</span> <span class=n>multipartFile</span><span class=o>)</span> <span class=o>{</span>
		<span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;### upload&#34;</span><span class=o>);</span>
		<span class=n>File</span> <span class=n>targetFile</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;/home1/irteam/&#34;</span> <span class=o>+</span> <span class=n>multipartFile</span><span class=o>.</span><span class=na>getOriginalFilename</span><span class=o>());</span>
		<span class=k>try</span> <span class=o>{</span>
			<span class=n>InputStream</span> <span class=n>fileStream</span> <span class=o>=</span> <span class=n>multipartFile</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>();</span>
			<span class=n>FileUtils</span><span class=o>.</span><span class=na>copyInputStreamToFile</span><span class=o>(</span><span class=n>fileStream</span><span class=o>,</span> <span class=n>targetFile</span><span class=o>);</span>
		<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
			<span class=n>FileUtils</span><span class=o>.</span><span class=na>deleteQuietly</span><span class=o>(</span><span class=n>targetFile</span><span class=o>);</span>
			<span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
		<span class=o>}</span>
		<span class=k>return</span> <span class=s>&#34;redirect:/form&#34;</span><span class=o>;</span>
	<span class=o>}</span>
<span class=o>}</span>

</code></pre></div><p><code>upload</code> 요청이 들어오면 <code>file</code>이라는 이름의 파라미터로 <code>MultipartFile</code>을 받고 파일의 이름을 확인 후 스트림을 읽어 특정 경로에 파일로 저장하는 로직이다. 그다음 <code>/form</code>을 접속하게 되면 나오는 폼 화면을 만들자. 이것도 아주 심플하게!</p><div class=highlight><pre class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>파일 업로드<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;/upload&#34;</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;post&#34;</span> <span class=na>enctype</span><span class=o>=</span><span class=s>&#34;multipart/form-data&#34;</span><span class=p>&gt;</span>
	<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;file&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;파일 선택&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;file&#34;</span><span class=p>/&gt;</span>
	<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;업로드&#34;</span><span class=p>/&gt;</span>
<span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</code></pre></div><p><code>multipart/form-data</code> 라는 Content-Type 을 명시해주고 파일을 선택하면 <code>/upload</code>로 POST요청을 하도록 설정한다. 이렇게 되면 너무 간단하게 + 이상없이 파일이 업로드가 잘 되니 이게 이야기 할 꺼리인가(?) 싶을정도로 심플하다.</p><h2 id=그런데-파일-크기가-크다면>그런데 파일 크기가 크다면?</h2><figure><a class=lightgallery href=/images/spring-file-upload/omg.jpg title=/images/spring-file-upload/omg.jpg data-thumbnail=/images/spring-file-upload/omg.jpg data-sub-html="<h2>설마 파일 업로드 하는 용량이 크겠어?&mldr; 왠지 파일의 용량이 크면 문제있을것 같은데&mldr; 출처 : https://m.blog.naver.com/naibbo0407/30170815180</h2>"><img class=lazyload src=/svg/loading.min.svg data-src=/images/spring-file-upload/omg.jpg data-srcset="/images/spring-file-upload/omg.jpg, /images/spring-file-upload/omg.jpg 1.5x, /images/spring-file-upload/omg.jpg 2x" data-sizes=auto alt=/images/spring-file-upload/omg.jpg width=80%></a><figcaption class=image-caption>설마 파일 업로드 하는 용량이 크겠어?&mldr; 왠지 파일의 용량이 크면 문제있을것 같은데&mldr;<br>출처 : <a href=https://m.blog.naver.com/naibbo0407/30170815180>https://m.blog.naver.com/naibbo0407/30170815180</a></figcaption></figure><p>개발을 하다보면 항상 생각해야 할 부분중에 하나가 바로 확장성인것 같다. 이 부분에서 역시 문제가 되었던 것. 평소보다 용량이 큰 파일이 업로드가 되면서 (평소 3~400MB 였다가 3~4GB정도의 파일이 업로드가 되는 매직) 업로드가 안되는 상황이 발생하였다. 당연히 문제가 발생하면 누군가 말했듯 로그부터 살펴보았는데 Apache - (AJP) - Tomcat 으로 구성된 환경에서 tomcat 로그에 <code>### upload</code>라는 로그가 없고 아파치 로그엔 <code>502 에러</code>가 발생한 것이었다. 왜 톰켓 로그도 안남고 그전에 에러가 발생하였을까?
이때부터 (근거없는 추측을 하며&mldr;) 고난과 역경의 삽질을 하기 시작하게 된다. 톰켓 버전이 문제일까? 로그가 안찍혔다면 다른 필터나 인터셉터에서 무언가를 먹고(?)있는건 아닐까? 잠깐, 근데 원래 대용량 업로드가 되긴 해? 파일 업로드/다운로드 하는 사이트 보면 별도 프로그램으로 하던데&mldr; 꼬불꼬불 미로속을 헤메는것만 같았던 삽질의 문제는 결국 <code>메모리</code>에 있었다.
파일을 업로드 하게 되면 해당 내용을 우선 메모리에 담게 되고 다 담은 후 메모리에 있는 내용을 was에 전달한 뒤 HttpServletRequest 로 넘어오게 된다.(Apache > Tomcat) 그런데 파일을 업로드 하면서 메모리에 파일이 써지다가 메모리 부족으로 OOM이 발생하게 되버린 것이었다. 또한 스프링 파일 최대크기를 별도로 지정하지 않고 있었기 때문에 메모리가 충분했다 하더라도 에러가 발생했을 상황이었다. ( <a href=https://spring.io/guides/gs/uploading-files/>https://spring.io/guides/gs/uploading-files/</a> 참조 )</p><pre><code>spring.servlet.multipart.max-file-size
spring.servlet.multipart.max-request-size
</code></pre><p>그러다보니 웹 서버인 아파치에서는 was 에러인 <code>503</code>이 아닌 <code>502</code>라고 에러를 발생하던 것이였고 지나고 보면 정말 아무것도 아닌 간단한 설정들을 놓친 문제였는데 꽤나 긴 시간을 허비해야만 했던 안타깝지만 보람찼던 (응?) 트러블 슈팅이었다.</p><h2 id=삽질은-곧-경험이-되고-시야가-된다>삽질은 곧 경험이 되고 시야가 된다.</h2><p>legacy 로직이다보니 was가 파일 업로드 처리를 하게 되었는데 가급적이면 was가 처리하는것 보다는 static 파일을 처리할 수 있는 별도의 웹서버를 만드는게 어떨까 생각이 든다. (조금 알아보니 nodejs 모듈인 <a href=https://github.com/expressjs/multer target=_blank rel="noopener noreffer">multer</a> 라는게 있다.) 물론 파일 업로드 한 뒤에 별도의 로직을 처리하려면 was가 관여를 해야겠지만 이 부분은 설계를 어떻게 하냐에 따라 충분히 해결할 수 있을것으로 보인다. (웹서버에서 파일을 업로드 한 뒤 비동기로 파일 업로드 완료여부에 따라 was에서 처리를 한다거나 등&mldr;)
더불어 항상 어플리케이션을 만들때에는 <code>예외처리</code>라는 것을 생각하면서 개발해야한다고 느끼게 되었다. NPE 같은 사소한 로직에서의 예외처리부터 파일 업로드시 서버의 메모리를 생각할수 있는 시야. 이런게 경험이 아닐까 싶다.
또한 (잘 돌아가니까) 환경설정 값을 수정하지 않고 배포하는 것보단 가급적 어떤 설정값들에 의해서 어플리케이션이 돌아가는지 특히, 스프링 같은 프레임워크의 도움을 받는다면 해당 프레임워크의 설정값들을 수정하며 성능에 이득을 취할 부분들은 없는지 꼼꼼하게 개발하는 습관을 길러야 할 것 같다.</p></div><center><style>.bmc-button img{width:27px!important;margin-bottom:1px!important;box-shadow:none!important;border:none!important;vertical-align:middle!important}.bmc-button{line-height:29px!important;height:30px!important;text-decoration:none!important;display:inline-flex!important;color:#000!important;background-color:#fd0!important;border-radius:3px!important;border:1px solid transparent!important;padding:1px 9px!important;font-size:22px!important;letter-spacing:.6px!important;box-shadow:0 1px 2px rgba(190,190,190,.5)!important;-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;margin:0 auto!important;font-family:cookie,cursive!important;-webkit-box-sizing:border-box!important;box-sizing:border-box!important;-o-transition:.3s all linear!important;-webkit-transition:.3s all linear!important;-moz-transition:.3s all linear!important;-ms-transition:.3s all linear!important;transition:.3s all linear!important}.bmc-button:hover,.bmc-button:active,.bmc-button:focus{-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;text-decoration:none!important;box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;opacity:.85!important;color:#000!important}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel=stylesheet><center><br><a class=bmc-button target=_blank href=https://www.buymeacoffee.com/taetaetae><img src=https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg alt="Buy me a coffee"><span style=margin-left:5px>Buy me a coffee</span></a>
<a href=https://bit.ly/ddbSupport target=_blank><img src=https://i.imgur.com/peaYpjh.png style=height:28px></a></center><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2019-07-21</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://taetaetae.github.io/2019/07/21/spring-file-upload/ data-title="스프링을 활용한 대용량 파일 업로드 구현" data-hashtags=fileupload,spring,archives-2019><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://taetaetae.github.io/2019/07/21/spring-file-upload/ data-hashtag=fileupload><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://taetaetae.github.io/2019/07/21/spring-file-upload/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="Share on Blogger" data-sharer=blogger data-url=https://taetaetae.github.io/2019/07/21/spring-file-upload/ data-title="스프링을 활용한 대용량 파일 업로드 구현" data-description><i class="fab fa-blogger fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/fileupload/>fileupload</a>,&nbsp;<a href=/tags/spring/>spring</a>,&nbsp;<a href=/tags/archives-2019/>archives-2019</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/2019/07/07/review-first-half-2019/ class=prev rel=prev title="2019 상반기 리뷰 (feat. 글또)"><i class="fas fa-angle-left fa-fw"></i>2019 상반기 리뷰 (feat. 글또)</a>
<a href=/2019/08/04/apache-load-balancing/ class=next rel=next title="아파치 로드밸런싱으로 여러 WAS 운영하기">아파치 로드밸런싱으로 여러 WAS 운영하기<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.74.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2016 - 2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://taetaetae.github.io/resume target=_blank>태태태</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":500},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"Comment","lightTheme":"github-light","repo":"taetaetae/blog-comment"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','UA-86432198-1',{'anonymize_ip':true});</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-86432198-1" async></script></body></html>